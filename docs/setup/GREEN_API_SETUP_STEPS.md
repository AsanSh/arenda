# üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Green API - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## ‚úÖ –®–∞–≥ 1: –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

–ú–∏–≥—Ä–∞—Ü–∏—è `0005_loginattempt` —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞. –¢–∞–±–ª–∏—Ü–∞ `login_attempts` —Å–æ–∑–¥–∞–Ω–∞.

## üìã –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –≤ Green API

### 2.1 –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Green API

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://console.green-api.com/
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç

### 2.2 –ù–∞–π–¥–∏—Ç–µ –≤–∞—à instance

- **ID Instance:** `7107486710`
- **API Token Instance:** `6633644896594f7db36235195f23579325e7a9498eab4411bd`

### 2.3 –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Webhook URL

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ instance `7107486710`
2. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª **"Webhook"** –∏–ª–∏ **"–í—Ö–æ–¥—è—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"** (Incoming notifications)
3. –í –ø–æ–ª–µ **"Webhook URL"** —É–∫–∞–∂–∏—Ç–µ:

   **–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (HTTP):**
   ```
   http://assetmanagement.team/api/webhooks/greenapi/incoming/
   ```

   **–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (–ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSL):**
   ```
   https://assetmanagement.team/api/webhooks/greenapi/incoming/
   ```

4. –í–∫–ª—é—á–∏—Ç–µ **"–í—Ö–æ–¥—è—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"** (Incoming notifications)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 2.4 –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
- ‚úÖ Webhook URL —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –í—Ö–æ–¥—è—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã
- ‚úÖ –¢–∏–ø webhook: `HTTP` (–Ω–µ WebSocket)

## üß™ –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 3.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoint —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ø—ã—Ç–∫–∏

```bash
curl -X POST http://assetmanagement.team/api/auth/whatsapp/start/ \
  -H "Content-Type: application/json"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "attemptId": "uuid-–∑–¥–µ—Å—å",
  "expiresAt": "2026-01-23T17:30:00Z",
  "loginMessage": "AMT LOGIN uuid-–∑–¥–µ—Å—å",
  "qrPayload": "AMT LOGIN uuid-–∑–¥–µ—Å—å"
}
```

### 3.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook endpoint

```bash
curl -X POST http://assetmanagement.team/api/webhooks/greenapi/incoming/ \
  -H "Content-Type: application/json" \
  -d '{"typeWebhook":"test"}'
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç—É—Å 200 (–¥–∞–∂–µ –µ—Å–ª–∏ webhook –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è).

### 3.3 –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://assetmanagement.team/login`
2. –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è QR-–∫–æ–¥ —Å —Ç–µ–∫—Å—Ç–æ–º "AMT LOGIN <attemptId>"
3. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ WhatsApp
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
5. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–∞—à –Ω–æ–º–µ—Ä –∏ —Ä–æ–ª—å

## üìù –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
```
AMT LOGIN <attemptId>
```

–ì–¥–µ `<attemptId>` - —ç—Ç–æ UUID –∏–∑ QR-–∫–æ–¥–∞.

## üîç Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. Webhook URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
2. Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ backend
3. Backend –∑–∞–ø—É—â–µ–Ω: `docker compose ps backend`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker compose logs backend | grep webhook`

### –ü—Ä–æ–±–ª–µ–º–∞: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
cd /root/arenda/infra
docker compose exec backend python manage.py migrate

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞
docker compose exec backend python manage.py dbshell
# –í PostgreSQL: \dt login_attempts
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ —É–∫–∞–∑–∞–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –ù–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ E.164 (+996XXXXXXXXX) –∏–ª–∏ –±–µ–∑ +996
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker compose logs backend | grep "Tenant not found"`

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (`login_attempts` —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞)
- [ ] Webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Green API
- [ ] –í—Ö–æ–¥—è—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã
- [ ] Backend –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç
- [ ] Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] Endpoint `/api/auth/whatsapp/start/` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Endpoint `/api/webhooks/greenapi/incoming/` –¥–æ—Å—Ç—É–ø–µ–Ω

## üéØ –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://assetmanagement.team/login`
2. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp
4. –í—Ö–æ–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ!
